<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Lluna</title>

  <style>
:root{
  --bg:#ffffff;
  --text:#111111;
  --muted:rgba(0,0,0,.65);
  --border:rgba(0,0,0,.18);
  --card: rgba(0,0,0,0.03);

  --perigeu:#ffd400; /* groc */
  --apogeu:#19d6ff;  /* blau/cian */
}

/* MODE NOCTURN automàtic */
@media (prefers-color-scheme: dark){
  :root{
    --bg:#0b0c10;
    --text:#f3f4f6;
    --muted:rgba(255,255,255,.70);
    --border:rgba(255,255,255,.18);
    --card: rgba(255,255,255,0.06);

    --perigeu:#ffd84d;
    --apogeu:#4fe3ff;
  }
}

body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:16px;
}

a{ color: var(--text); text-decoration:none; opacity:.9; }
a:active{ opacity:1; }

.wrap{ max-width:520px; margin:0 auto; }

.err{
  margin-top:16px;
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:12px;
  font-size:14px;
  background: var(--card);
  display:none;
}

/* Capçalera */
.header{ margin-top: 6px; }
.header h1{
  margin: 8px 0 6px;
  font-size: 40px;
  line-height: 1.05;
  letter-spacing: -0.5px;
}

.sub{
  text-align:center;
  margin-top: 4px;
}
.sub .date{
  color:var(--muted);
  font-size: 20px;
  margin: 2px 0;
}
.sub .age{
  color:var(--muted);
  font-size: 20px;
  margin: 2px 0 0;
}

/* LLUNA */
.moonbox{
  display:flex;
  justify-content:center;
  margin: 12px 0 6px;
}
.moonbox svg{
  width: 200px;
  height: 200px;
  max-width: 60vw;
  max-height: 60vw;
  overflow: visible;
}

/* Llegenda */
.legend{
  text-align:center;
  color:var(--muted);
  font-size: 16px;
  margin: 6px 0 10px;
  line-height: 1.2;
}

/* KPI “taula” 2 columnes */
.kpiGrid{
  width: 100%;
  margin: 14px auto 8px;
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 6px 14px;
  max-width: 360px;
  font-size: 22px;
}
.kpiGrid .k{ color:var(--muted); }
.kpiGrid .v{
  font-weight: 800;
  text-align: right;
  font-variant-numeric: tabular-nums;
}

/* link tornar */
#back{ color: var(--text); opacity: .9; }
  </style>
</head>

<body>
  <div class="wrap">
    <a href="#" id="back">← Tornar</a>

    <div class="header">
      <h1 id="title">La Lluna avui</h1>
    </div>

    <div class="sub">
      <div class="date">Data: <span id="d"></span></div>
      <div class="age" id="age">Edat de la lluna: —</div>
    </div>

    <div class="moonbox" id="moonbox"></div>

    <div class="legend" id="legend">
      groc=perigeu<br>blau=apogeu
    </div>

    <div class="kpiGrid" id="kpiGrid">
      <div class="k">Il·luminació:</div><div class="v" id="kIll">—</div>
      <div class="k">Fase:</div><div class="v" id="kPhase">—</div>
      <div class="k">Mida aparent:</div><div class="v" id="kSize">—</div>
      <div class="k">Distància:</div><div class="v" id="kDist">—</div>
    </div>

    <div class="err" id="err"></div>
  </div>

  <!-- astronomy-engine (local) -->
  <script src="assets/js/astronomy.browser.min.js"></script>

  <script>
    const p = new URLSearchParams(location.search);
    const dateStr = p.get("date"); // "YYYY-MM-DD"
    document.getElementById("d").textContent = dateStr || "";

    document.getElementById("back").addEventListener("click", (e) => {
      e.preventDefault();
      window.history.back();
    });

    function parseISODateLocal(iso){
      if (!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return new Date();
      const [y,m,d] = iso.split("-").map(Number);
      return new Date(y, m-1, d, 12, 0, 0); // migdia local (estable)
    }

    function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }
    function deg2rad(d){ return d * Math.PI / 180; }

    function fmtPct(x, decimals = 2){
      if (!Number.isFinite(x)) return "—";
      return `${x.toFixed(decimals)}%`;
    }

    function inSameLocalDay(d, day){
      const a0 = new Date(day); a0.setHours(0,0,0,0);
      const a1 = new Date(day); a1.setHours(23,59,59,999);
      return d >= a0 && d <= a1;
    }

    // Retorna el nom “oficial de calendari” del dia si hi ha fase exacta (nova/plena/quarts)
    function phaseExactNameForDay(day){
      const t0 = Astronomy.MakeTime(day);
      const targets = [
        { angle: 0,   name: "Lluna nova" },
        { angle: 90,  name: "Quart creixent" },
        { angle: 180, name: "Lluna plena" },
        { angle: 270, name: "Quart minvant" },
      ];

      for (const it of targets){
        const ev = Astronomy.SearchMoonPhase(it.angle, t0, 2); // dins +2 dies
        if (ev && inSameLocalDay(ev.date, day)) return it.name;
      }
      return "";
    }

    // Etiqueta “estil calendari astronòmic”
    function phaseLabelForDay(phaseDeg, illum, day){
      const exact = phaseExactNameForDay(day);
      if (exact) return exact;

      const d = ((phaseDeg % 360) + 360) % 360;
      if (d > 0 && d < 180){
        // creixent
        return (illum < 0.5) ? "Crescent creixent" : "Gibosa creixent";
      } else {
        // minvant
        return (illum < 0.5) ? "Crescent minvant" : "Gibosa minvant";
      }
    }

    // Edat de la lluna (dies des de la lluna nova anterior)
    function moonAgeDays(day){
      const t = Astronomy.MakeTime(day);
      const prevNew = Astronomy.SearchMoonPhase(0, t, -35); // cercar cap enrere
      if (!prevNew) return null;
      const ms = day.getTime() - prevNew.date.getTime();
      return ms / (1000 * 60 * 60 * 24);
    }

    function renderMoonSVG(opts){
      const {
        R_perigeu = 108,
        R_apogeu  = 96,
        R_now     = 102,
        illum = 0.5,
        waxing = true
      } = opts;

      const cx = 120, cy = 120;
      const R = R_now;

      // Terminador real (el·lipse)
      const cosPhi = (2 * clamp(illum, 0, 1)) - 1;
      let rx = Math.abs(cosPhi) * R;
      if (rx < 0.001) rx = 0.001;

      const isGibbous = illum > 0.5;
      const sweepLimb = waxing ? 1 : 0;

      let sweepTerm;
      if (!isGibbous) sweepTerm = waxing ? 0 : 1;  // crescent
      else            sweepTerm = waxing ? 1 : 0;  // gibbous

      const almostNew  = illum < 0.01;
      const almostFull = illum > 0.99;

      const pathLit = `
        M ${cx} ${cy - R}
        A ${R} ${R} 0 0 ${sweepLimb} ${cx} ${cy + R}
        A ${rx} ${R} 0 0 ${sweepTerm} ${cx} ${cy - R}
        Z
      `;

      // Imatge base
      const IMG = "assets/moon/plena.png";

      return `
<svg viewBox="0 0 240 240" aria-label="Fase lunar" role="img">
  <defs>
    <clipPath id="clipDisc">
      <circle cx="${cx}" cy="${cy}" r="${R}"></circle>
    </clipPath>

    <!-- Mascara ombra: aplica vel només a la part fosca -->
    <mask id="maskShadow">
      <rect x="0" y="0" width="240" height="240" fill="black"></rect>
      <circle cx="${cx}" cy="${cy}" r="${R}" fill="white"></circle>
      ${almostNew ? "" : `<path d="${pathLit}" fill="black"></path>`}
    </mask>

    <!-- Mascara zona il·luminada -->
    <mask id="maskLit">
      <rect x="0" y="0" width="240" height="240" fill="black"></rect>
      ${
        almostFull
          ? `<circle cx="${cx}" cy="${cy}" r="${R}" fill="white"></circle>`
          : (almostNew ? "" : `<path d="${pathLit}" fill="white"></path>`)
      }
    </mask>
  </defs>

  <!-- Anells -->
  <circle cx="${cx}" cy="${cy}" r="${R_perigeu}" fill="none" stroke="var(--perigeu)" stroke-width="2.5"></circle>
  <circle cx="${cx}" cy="${cy}" r="${R_apogeu}"  fill="none" stroke="var(--apogeu)"  stroke-width="2.5"></circle>

  <!-- Base: imatge una mica enfosquida -->
  <g clip-path="url(#clipDisc)">
    <image href="${IMG}" x="${cx-R}" y="${cy-R}" width="${2*R}" height="${2*R}"
           preserveAspectRatio="xMidYMid slice" opacity="0.75"></image>
  </g>

  <!-- Zona il·luminada: imatge a opacitat 1 -->
  <g clip-path="url(#clipDisc)" mask="url(#maskLit)">
    <image href="${IMG}" x="${cx-R}" y="${cy-R}" width="${2*R}" height="${2*R}"
           preserveAspectRatio="xMidYMid slice" opacity="1"></image>
  </g>

  <!-- Ombra -->
  <g clip-path="url(#clipDisc)" mask="url(#maskShadow)">
    <rect x="${cx-R}" y="${cy-R}" width="${2*R}" height="${2*R}" fill="rgba(0,0,0,0.65)"></rect>
  </g>

  <!-- Contorn -->
  <circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="rgba(0,0,0,0.25)" stroke-width="1"></circle>
</svg>`;
    }

    (function main(){
      const errEl = document.getElementById("err");
      const box = document.getElementById("moonbox");

      try{
        if (typeof Astronomy === "undefined") throw new Error("Astronomy Engine no s'ha carregat.");

        const day = parseISODateLocal(dateStr);
        const t = Astronomy.MakeTime(day);

        // Fase (0..360): 0 nova, 90 quart creixent, 180 plena, 270 quart minvant
        const phaseDeg = Astronomy.MoonPhase(t);
        const waxing = (phaseDeg >= 0 && phaseDeg < 180);

        // Il·luminació 0..1 a partir de l'angle simètric 0..180
        const phaseAngle = (phaseDeg <= 180) ? phaseDeg : (360 - phaseDeg);
        const illum = (1 - Math.cos(deg2rad(phaseAngle))) / 2;

        // Distància geocèntrica Terra-Lluna (AU) i diàmetre angular (arcmin)
        const v = Astronomy.GeoVector(Astronomy.Body.Moon, t, true);
        const rAU = Math.sqrt(v.x*v.x + v.y*v.y + v.z*v.z);

        const AU_KM = (typeof Astronomy.AU_KM === "number") ? Astronomy.AU_KM : 149597870.7;
        const distKm = rAU * AU_KM;

        const R_MOON_KM = 1737.4;
        const angRad = 2 * Math.atan(R_MOON_KM / distKm);
        const angArcmin = (angRad * 180 / Math.PI) * 60;

        // Escalat del disc entre apogeu/perigeu (valors típics)
        const APog = 29.4;
        const PErig = 33.5;

        const R_perigeu = 108;
        const R_apogeu  = 96;

        const u = clamp((angArcmin - APog) / (PErig - APog), 0, 1);
        const R_now = R_apogeu + u * (R_perigeu - R_apogeu);

        // Labels
        const exact = phaseExactNameForDay(day);
        const label = phaseLabelForDay(phaseDeg, illum, day);

        // === KPI (percentatge amb decimals) ===
        document.getElementById("kIll").textContent  = fmtPct(illum*100, 2);
        document.getElementById("kSize").textContent = `${angArcmin.toFixed(1)}′`;
        document.getElementById("kDist").textContent = `${Math.round(distKm).toLocaleString("ca-ES")} km`;

        // Fase: si és exacta, només nom; si no, nom + graus
        document.getElementById("kPhase").textContent = exact ? exact : `${label} · ${phaseDeg.toFixed(1)}°`;

        // === Edat de la lluna ===
        const age = moonAgeDays(day);
        const ageEl = document.getElementById("age");
        ageEl.textContent = Number.isFinite(age)
          ? `Edat de la lluna: ${age.toFixed(1)} dies`
          : "Edat de la lluna: —";

        // === Títol gran ===
        const titleEl = document.getElementById("title");

        const isFullDay = (exact === "Lluna plena");
        const isSuper = isFullDay && distKm < 370000; // ajusta llindar si vols

        if (isFullDay) {
          titleEl.textContent = isSuper ? "Lluna Plena (Super lluna)" : "Lluna Plena";
        } else if (exact === "Lluna nova") {
          titleEl.textContent = "Lluna Nova";
        } else if (exact === "Quart creixent") {
          titleEl.textContent = "Quart Creixent";
        } else if (exact === "Quart minvant") {
          titleEl.textContent = "Quart Minvant";
        } else {
          titleEl.textContent = "La Lluna avui";
        }

        // SVG
        box.innerHTML = renderMoonSVG({ R_perigeu, R_apogeu, R_now, illum, waxing });

      }catch(e){
        console.error(e);
        errEl.style.display = "block";
        errEl.textContent = "Error: " + (e?.message || e);
      }
    })();
  </script>
</body>
</html>
