<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Lluna</title>

  <style>
    :root{
      --bg:#fff;
      --text:#111;
      --muted:rgba(0,0,0,.65);
      --border:rgba(0,0,0,.18);
      --perigeu:#ffd400; /* groc */
      --apogeu:#19d6ff;  /* blau/cian */
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, sans-serif;
      background:var(--bg);
      color:var(--text);
      padding:16px;
    }
    a{ color: var(--text); text-decoration:none; opacity:.9; }
    a:active{ opacity:1; }

    .wrap{ max-width:520px; margin:0 auto; }
    .top{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:8px; }
    .kpi{ white-space:pre-line; font-size:16px; line-height:1.2; text-align:right; }
    .kpi b{ font-weight:800; }
    .muted{ color:var(--muted); font-size:14px; margin-top:8px; }

    .moonbox{
      display:flex;
      justify-content:center;
      margin: 16px 0 10px;
    }
    .moonbox svg{
      width: 240px;
      height: 240px;
      max-width: 70vw;
      max-height: 70vw;
      overflow: visible;
    }

    .err{
      margin-top:16px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      font-size:14px;
      background: rgba(0,0,0,0.03);
      display:none;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <a href="#" id="back">← Tornar</a>

    <div class="top">
      <h1 style="margin:10px 0 0; font-size:22px;">La Lluna avui</h1>
      <div class="kpi" id="kpi">Carregant…</div>
    </div>

    <div class="muted">Data: <span id="d"></span></div>

    <div class="moonbox" id="moonbox"></div>

    <div class="muted" id="meta"></div>
    <div class="err" id="err"></div>
  </div>

  <!-- astronomy-engine (local) -->
  <script src="assets/js/astronomy.browser.min.js"></script>

  <script>
    const p = new URLSearchParams(location.search);
    const dateStr = p.get("date"); // "YYYY-MM-DD"

    document.getElementById("d").textContent = dateStr || "";

    document.getElementById("back").addEventListener("click", (e) => {
      e.preventDefault();
      window.history.back();
    });

    function parseISODateLocal(iso){
      if (!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return new Date();
      const [y,m,d] = iso.split("-").map(Number);
      return new Date(y, m-1, d, 12, 0, 0); // migdia local
    }

    function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }
    function deg2rad(d){ return d * Math.PI / 180; }
    function fmtPct(x){
      if (!Number.isFinite(x)) return "—";
      return `${Math.round(x)}%`;
    }

    // Dibuix: terminador real (el·lipse) + anells apogeu/perigeu + mida function renderMoonSVG(opts){
  function renderMoonSVG(opts){
    const {
    R_perigeu = 108,
    R_apogeu  = 96,
    R_now     = 102,
    illum = 0.5,
    waxing = true
  } = opts;

  const cx = 120, cy = 120;
  const R = R_now;

  // Terminador real (el·lipse)
  const cosPhi = (2 * clamp(illum, 0, 1)) - 1;
  let rx = Math.abs(cosPhi) * R;
  if (rx < 0.001) rx = 0.001;

  const isGibbous = illum > 0.5;
  const sweepLimb = waxing ? 1 : 0;

  let sweepTerm;
  if (!isGibbous) sweepTerm = waxing ? 0 : 1;  // crescent
  else            sweepTerm = waxing ? 1 : 0;  // gibbous

  const almostNew  = illum < 0.01;
  const almostFull = illum > 0.99;

  // Path de la part il·luminada
  const pathLit = `
    M ${cx} ${cy - R}
    A ${R} ${R} 0 0 ${sweepLimb} ${cx} ${cy + R}
    A ${rx} ${R} 0 0 ${sweepTerm} ${cx} ${cy - R}
    Z
  `;

  // Ruta de la teva imatge (canvia-la si cal)
  const IMG = "assets/moon/plena.png";

  return `
<svg viewBox="0 0 240 240" aria-label="Fase lunar" role="img">
  <defs>
    <clipPath id="clipDisc">
      <circle cx="${cx}" cy="${cy}" r="${R}"></circle>
    </clipPath>

    <!-- Mascara per aplicar ombra només a la part NO il·luminada -->
    <mask id="maskShadow">
      <!-- blanc = es veu (ombra), negre = no es veu (llum) -->
      <rect x="0" y="0" width="240" height="240" fill="black"></rect>

      <!-- Ombram tot el disc... -->
      <circle cx="${cx}" cy="${cy}" r="${R}" fill="white"></circle>

      <!-- ...excepte la zona il·luminada (la “treiem” amb negre) -->
      ${almostNew ? "" : `<path d="${pathLit}" fill="black"></path>`}
    </mask>

    <!-- Mascara per pintar la zona il·luminada amb la imatge tal qual -->
    <mask id="maskLit">
      <rect x="0" y="0" width="240" height="240" fill="black"></rect>
      ${almostFull ? `<circle cx="${cx}" cy="${cy}" r="${R}" fill="white"></circle>`
                   : (almostNew ? "" : `<path d="${pathLit}" fill="white"></path>`)}
    </mask>
  </defs>

  <!-- Anells de referència -->
  <circle cx="${cx}" cy="${cy}" r="${R_perigeu}" fill="none" stroke="var(--perigeu)" stroke-width="2.5"></circle>
  <circle cx="${cx}" cy="${cy}" r="${R_apogeu}"  fill="none" stroke="var(--apogeu)"  stroke-width="2.5"></circle>

  <!-- Base: imatge (disc complet, però enfosquida lleugerament perquè el “lit” destaqui) -->
  <g clip-path="url(#clipDisc)">
    <image href="${IMG}" x="${cx-R}" y="${cy-R}" width="${2*R}" height="${2*R}" preserveAspectRatio="xMidYMid slice" opacity="0.75"></image>
  </g>

  <!-- Zona il·luminada: imatge a opacitat 1 (mateixa imatge, però només a la part lit) -->
  <g clip-path="url(#clipDisc)" mask="url(#maskLit)">
    <image href="${IMG}" x="${cx-R}" y="${cy-R}" width="${2*R}" height="${2*R}" preserveAspectRatio="xMidYMid slice" opacity="1"></image>
  </g>

  <!-- Ombra: un vel negre aplicat només a la part fosca -->
  <g clip-path="url(#clipDisc)" mask="url(#maskShadow)">
    <rect x="${cx-R}" y="${cy-R}" width="${2*R}" height="${2*R}" fill="rgba(0,0,0,0.65)"></rect>
  </g>

  <!-- Contorn -->
  <circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="rgba(0,0,0,0.25)" stroke-width="1"></circle>
</svg>`;
}

    (function main(){
      const errEl = document.getElementById("err");
      const kpiEl = document.getElementById("kpi");
      const metaEl = document.getElementById("meta");
      const box = document.getElementById("moonbox");

      try{
        if (typeof Astronomy === "undefined") throw new Error("Astronomy Engine no s'ha carregat.");

        const day = parseISODateLocal(dateStr);
        const t = Astronomy.MakeTime(day);

        // Fase (0..360): 0 nova, 90 quart creixent, 180 plena, 270 quart minvant
        const phaseDeg = Astronomy.MoonPhase(t);
        const waxing = (phaseDeg >= 0 && phaseDeg < 180);

        // Il·luminació 0..1 a partir de l'angle simètric 0..180
        const phaseAngle = (phaseDeg <= 180) ? phaseDeg : (360 - phaseDeg);
        const illum = (1 - Math.cos(deg2rad(phaseAngle))) / 2;

        // Distància geocèntrica Terra-Lluna (AU) i diàmetre angular (arcmin)
        const v = Astronomy.GeoVector(Astronomy.Body.Moon, t, true);
        const rAU = Math.sqrt(v.x*v.x + v.y*v.y + v.z*v.z);

        const AU_KM = (typeof Astronomy.AU_KM === "number") ? Astronomy.AU_KM : 149597870.7;
        const distKm = rAU * AU_KM;

        const R_MOON_KM = 1737.4;
        const angRad = 2 * Math.atan(R_MOON_KM / distKm);
        const angArcmin = (angRad * 180 / Math.PI) * 60;

        // Referències típiques apogeu/perigeu (arcmin) per escalar el disc
        const APog = 29.4;
        const PErig = 33.5;

        const R_perigeu = 108;
        const R_apogeu  = 96;

        const u = clamp((angArcmin - APog) / (PErig - APog), 0, 1);
        const R_now = R_apogeu + u * (R_perigeu - R_apogeu);

        kpiEl.innerHTML =
          `<b>Il·luminació:</b> ${fmtPct(illum*100)}\n` +
          `<b>Fase:</b> ${phaseDeg.toFixed(1)}° (${waxing ? "creixent" : "minvant"})\n` +
          `<b>Mida aparent:</b> ${angArcmin.toFixed(1)}′`;

        metaEl.textContent =
          `Distància geocèntrica: ${Math.round(distKm).toLocaleString("ca-ES")} km · ` +
          `Anells: groc=perigeu (màx), blau=apogeu (mín)`;

        box.innerHTML = renderMoonSVG({ R_perigeu, R_apogeu, R_now, illum, waxing });

      }catch(e){
        console.error(e);
        errEl.style.display = "block";
        errEl.textContent = "Error: " + (e?.message || e);
        kpiEl.textContent = "No s'ha pogut calcular la Lluna.";
      }
    })();
  </script>
</body>
</html>
